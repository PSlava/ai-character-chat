# Backend Architecture (`backend/app/`)

## Core

- **`config.py`** — `pydantic-settings`. `async_database_url` property auto-converts `postgres://` to `postgresql+asyncpg://`. `autonomous_provider_order` setting: paid-only (default `together,openai,claude,deepseek`).
- **`db/models.py`** — SQLAlchemy models: `User` (with `role`, `oauth_provider`, `oauth_id`, nullable `password_hash`, `tier` (free/premium/admin), `tokens_used_today`, `tokens_used_month`, `tokens_reset_date`), `Character`, `Chat` (with `persona_name`, `persona_description` snapshot fields), `Message` (with `model_used`, `prompt_tokens`, `completion_tokens`), `Favorite`, `Vote` (user_id + character_id composite PK, value +1/-1), `Persona` (user_id, slug, name, description, is_default), `CharacterRelation` (character_id, related_id, relation_type, label_ru/en/es/fr/de/pt/it), `PromptTemplate`, `Report` (reporter_id, character_id, reason, details, status). `RelationType` enum: rival/ex/friend/sibling/enemy/lover/ally. Character has `appearance`, `speech_pattern` (speech style description), `structured_tags` (comma-separated tag IDs), `response_length` (short/medium/long/very_long), `max_tokens` (default 2048), `base_chat_count` and `base_like_count` (JSONB, per-language fake engagement counters), `vote_score` (net upvotes-downvotes), `fork_count`, `forked_from_id` (FK self-ref), `highlights` (JSONB array of {text, lang}).
- **`db/session.py`** — Async engine + session factory. `init_db()` creates tables on startup + runs ALTER TABLE migrations in separate transactions with `IF NOT EXISTS`.

## Auth

- **`auth/router.py`** — `POST /api/auth/register`, `/api/auth/login`, `/api/auth/forgot-password`, `/api/auth/reset-password`, `GET /api/auth/challenge` (PoW). Google OAuth: `GET /api/auth/google` (redirect to Google), `GET /api/auth/google/callback` (create/link user, redirect with JWT). Uses bcrypt directly, authlib for OAuth. `ADMIN_EMAILS` env var: auto-assigns admin role on register; syncs role on login. Anti-bot: honeypot field, PoW verification, registration rate limit (3/hr per IP), header-based bot delay (2s if missing Accept-Language/Referer).
- **`auth/pow.py`** — Proof-of-Work challenge system. `create_challenge()` generates random hex, `verify_pow()` checks SHA256 with 4 leading hex zeros. Single-use challenges, 5-min TTL, auto-cleanup.
- **`auth/rate_limit.py`** — In-memory sliding window rate limiter. Limiters: `auth_limiter` (10/min per IP), `register_limiter` (3/hr per IP), `message_limiter` (20/min per user), `message_interval_limiter` (1 per 5s per user), `reset_limiter` (3/5min per IP), `reset_hourly_limiter` (10/hr per IP), `reset_email_limiter` (1/2min per email).
- **`auth/middleware.py`** — `get_current_user` dependency. `get_current_user_optional` returns None instead of 401.

## LLM Providers (`llm/`)

Provider abstraction layer with 8 providers:

- `base.py` — `BaseLLMProvider` ABC with `generate_stream()`/`generate()`/`generate_with_usage()`. `LLMConfig` includes model, temperature, max_tokens, top_p, top_k, frequency_penalty. `LLMResult` dataclass: `content`, `prompt_tokens`, `completion_tokens`, `model`. `last_model_used` tracks actual model in auto-fallback.
- `registry.py` — `init_providers()` creates instances from env keys; `get_provider(name)` resolves.
- `openrouter_provider.py` — OpenRouter with auto-fallback (top-3 by quality), system role merge for Gemma, thinking model support.
- `openrouter_models.py` — Registry of 8 free models with quality scores (0-10). `get_fallback_models()` diversifies by provider.
- `groq_provider.py` — Groq with auto-fallback. OpenAI-compatible at `api.groq.com/openai/v1`. 6 free models.
- `groq_models.py` — Model registry with quality scores, NSFW support flags.
- `cerebras_provider.py` — Cerebras with auto-fallback. OpenAI-compatible at `api.cerebras.ai/v1`. 3 free models.
- `cerebras_models.py` — Model registry with quality scores. Note: Cerebras API does NOT support frequency/presence penalty.
- `together_provider.py` — Together AI with auto-fallback. OpenAI-compatible at `api.together.xyz/v1`. Paid (pay-per-token), no NSFW moderation.
- `together_models.py` — Model registry with quality scores, type-based filtering (chat/language only). `refresh_models()` uses httpx directly (not OpenAI SDK `client.models.list()`) to avoid Pydantic compatibility issues.
- `deepseek_provider.py` — Direct DeepSeek API (`api.deepseek.com/v1`). Supports `deepseek-reasoner` thinking model.
- `qwen_provider.py` — Direct Qwen/DashScope API (`dashscope-intl.aliyuncs.com`). Default: `qwen3-32b`. Thinking disabled via `enable_thinking: False`.
- `thinking_filter.py` — `ThinkingFilter` strips `<think>...</think>` blocks from streaming output. `strip_thinking()` for non-stream. `has_foreign_chars()` detects CJK/Vietnamese characters (Qwen artifact). `has_mixed_languages(text, lang)` detects English words mixed into ru/es text. Used in groq/together/cerebras providers' `generate()` to retry on bad responses.
- `model_cooldown.py` — Failed models excluded from auto-fallback for 15 minutes. **Provider-level blacklist**: 402 errors → entire provider blocked for 6h (`mark_provider_no_balance()`). `is_provider_available()` checks both auto-blacklist and admin-disabled. `handle_402_if_applicable()` detects 402/balance errors, blacklists provider, sends fire-and-forget email alert via `send_balance_alert()`. `get_blacklisted_providers()` returns status for admin UI. `set_admin_disabled()` syncs from DB settings. All providers call `handle_402_if_applicable()` in their except blocks; `registry.py:get_provider()` checks `is_provider_available()` — blocks propagate everywhere automatically.
- `anthropic_provider.py` — Anthropic/Claude provider. `claude-sonnet-4-6` default. Note: API forbids `temperature` + `top_p` together — provider sends only one (top_p takes priority).
- `openai_provider.py`, `gemini_provider.py` — Standard provider implementations.
- `router.py` — `GET /api/models/{openrouter,groq,cerebras,together}` returns model lists with quality scores.

## Admin

- **`admin/router.py`** — Admin-only CRUD for prompt template overrides. `require_admin` dependency checks JWT role. GET/PUT/DELETE `/api/admin/prompts`. Admin settings: `GET/PUT /api/admin/settings` (key-value in `prompt_templates` with `setting.` prefix). Settings: `notify_registration`, `notify_errors`, `paid_mode`, `cost_mode` (quality/balanced/economy), `daily_message_limit`, `max_personas`, `anon_message_limit`, `provider_enabled.{name}` (per-provider toggle, 9 providers). `GET /api/admin/provider-status` returns all providers with enabled/blacklisted/remaining status. `PUT settings/provider_enabled.{name}` syncs admin-disabled set to in-memory and clears auto-blacklist on re-enable.

## Chat System

- **`chat/prompt_builder.py`** — Dynamic system prompt from character fields. Two-layer system: `_DEFAULTS` (code) + DB overrides. `load_overrides(engine)` caches for 60s. `get_all_keys()` for admin UI. 23 keys x 7 languages (ru/en/es/fr/de/pt/it). Includes structured tags snippets (between personality and appearance), appearance section, speech_pattern section (between appearance and scenario), `{{char}}`/`{{user}}` template variable replacement in example dialogues. Response length instructions vary by `response_length` setting. Literary prose format per language: narration as plain text, dialogue via hyphen `-` (ru/es/fr/pt/it), quotes `"..."` (en/de). `*asterisks*` only for inner thoughts. **Third-person narration** enforced per language: she/he (en), she/he (ru), ella/el (es), elle/il (fr), sie/er (de), ela/ele (pt), lei/lui (it). Show-don't-tell, physical sensations, anti-template rules. **Anti-repetition rules**: no echo/paraphrase of user words, require new physical action in every response, advance plot forward, ban crutch words. **Anti-AI rules**: expanded banned AI-marker words per language (~30 each; RU: tapestry-equivalents; EN: delve, tapestry, testament, realm, landscape, eyes widened, bit her lip, etc.), sentence length variation required. **Anti-structural-repetition**: ban 2+ sentences starting with same subject (She/He/Her/His per language), banned RP cliche patterns (all 7 langs). **NSFW rules** (`content_nsfw`): 3 extra rules x 7 langs — keep character voice during intimacy, ban purple prose metaphors (waves of pleasure, fire within, symphony of sensations), show emotions through body not words. **DnD GM prompts** (`_DND_PROMPTS`): 7 languages, sections: intro, rules_summary, gm_rules, choices_rules, format_rules, character_creation. DnD detection: `campaign_id` OR 'dnd' in character tags. GM instructed to write `[ROLL]` at END of response as cliffhanger (no outcome narration), `[STATE {json}]` for encounter tracking. **Note**: never use German typographic quotes (U+201E) in Python source — causes SyntaxError.
- **`chat/service.py`** — `get_or_create_chat(force_new=False)` returns existing chat or creates new; `force_new=True` always creates new chat. Copies persona snapshot (name+description) into Chat at creation time. `get_chat_messages(limit, before_id)` supports cursor pagination with `has_more`. Context window (sliding window ~24k tokens, 50 messages). `build_conversation_messages(max_context_messages=None)` constructs LLM message list with system prompt, accepts tier-based context message limit. `save_message()` accepts `prompt_tokens` and `completion_tokens` for token tracking. **Post-history system**: `_POST_HISTORY_CORE` (base rules, 7 langs) + `_POST_HISTORY_VARIANTS` (5 rotating variants x 7 langs: setting/action/dialogue/subtext/personality-driven). `_get_post_history(lang, chat_id, msg_count, last_assistant_text, content_rating)` selects variant via `hash(chat_id + msg_count) % 5`. **Anti-echo**: extracts first 8 words of previous response, injects instruction to start differently. **Escalation**: after 12+ messages, adds stronger plot advancement mandate. **NSFW reminder**: when `content_rating == "nsfw"`, adds explicit vocabulary instructions (7 languages) — direct anatomical words, anti-euphemism rules (ban "manhood"/"womanhood"/"they became one"), dirty talk permission, "write like erotica professional". DnD/Fiction have own `_DND_POST_HISTORY` / `_FICTION_POST_HISTORY`. **Dice result injection**: `_format_dice_injection()` formats previous turn's dice results as system message; injected before post-history when last assistant message has `dice_rolls` JSONB. Closest to generation = strongest effect.
- **`chat/summarizer.py`** — Auto-summarize older messages when chat exceeds 25 messages (was 40). Keeps 15 most recent unsummarized (was 20). Summary must track current location and end with clear statement of where characters are. Providers: Groq → Cerebras → OpenRouter, 30s timeout. Fire-and-forget after each assistant response.
- **`chat/anon.py`** — Anonymous (guest) chat support. System user `anonymous@system.local` for FK compliance. `get_anon_user_id(db)` lazily creates/caches system user. `get_anon_message_limit()` reads `setting.anon_message_limit` (0=disabled, >0=limit, default 20). `check_anon_limit(session_id)` raises 403 if exceeded. `count_anon_messages()` counts user messages across all chats with matching `anon_session_id`.
- **`chat/daily_limit.py`** — Generic `_get_setting_int(key, default)` with 60s TTL cache. Exports `check_daily_limit()`, `get_max_personas()`, `get_cost_mode()`, `get_user_tier()`, `get_tier_limits()`, `cap_max_tokens()`. Reads from `prompt_templates` table with `setting.*` prefix. **Tier system**: `TIER_LIMITS` dict with 4 levels — anon (20 msg/day, 1024 max_tokens, 10 ctx msgs), free (200/day, 2048, 30 ctx), premium (unlimited, 4096, 50 ctx), admin (unlimited, 4096, 50 ctx). `cap_max_tokens(requested, tier)` enforces tier max_tokens ceiling.
- **`chat/router.py`** — SSE streaming via `StreamingResponse`. Events: `{type: "token"}`, `{type: "done", message_id, user_message_id, anon_messages_left?, dice_rolls?, encounter_state?}`, `{type: "error"}`. **DnD parsing**: `_parse_dice_rolls()` extracts `[ROLL NdM+X desc]`, rolls dice server-side; `_parse_encounter_state()` extracts `[STATE {json}]` (greedy regex for nested JSON); `_save_dice_on_message()` persists dice results on Message JSONB for next-turn injection. `is_dnd` flag: `campaign_id` OR 'dnd' in character tags. **Anonymous chat**: `POST /chats`, `GET /chats/{id}`, `GET /chats/{id}/messages`, `POST /chats/{id}/message` use `get_current_user_optional`; anonymous users identified by `X-Anon-Session` header; chat created under system anon user with `anon_session_id`. `GET /chats/anon-limit` returns limit/remaining/enabled. `POST /chats` supports `force_new` for multiple chats per character. `DELETE` endpoints require auth. `POST /chats/{id}/generate-persona-reply` — admin-only, non-streaming LLM call that ghostwrites a reply as the user's persona (returns text, doesn't save, counts toward daily limit). Cross-provider auto-fallback when `model_name == "auto"`. **cost_mode**: `get_cost_mode()` with 60s cache — `quality` (paid_mode behavior), `balanced` (paid for registered, free for anon), `economy` (free providers only). Tier-based `max_tokens` capping via `cap_max_tokens()`. Tier's `max_context_messages` passed to `build_conversation_messages()`. Token usage estimated and saved on messages (`prompt_tokens`, `completion_tokens`). Error sanitization: non-admin users see generic error, admin sees full details, moderation errors shown to all. **frequency_penalty defaults**: 0.5 for NSFW characters, 0.3 for others (when user doesn't override). **NSFW sampling**: temperature 0.95 (vs 0.85 default), presence_penalty 0.5 (vs 0.3 default) for NSFW characters.
- **`group_chat/router.py`** — Group chat API: `POST/GET/DELETE /api/group-chats`, `POST /api/group-chats/{id}/message`. Characters respond sequentially via SSE. Each character gets own system prompt + group context. Other characters' messages sent as user role with `[Name]:` prefix (prevents continuation of other's text). `max_tokens=600`, `MAX_MEMBERS=3`.

## Characters

- **`characters/`** — CRUD + AI generation from text + SillyTavern export/import + voting + forking. Tags as comma-separated string. `structured_tags.py` — registry of 33 predefined tags in 5 categories with labels and prompt snippets in all 7 languages (ru/en/es/fr/de/pt/it). `get_snippets_for_ids()` uses `snippet_{lang}` with fallback to `snippet_en`. Public characters require an avatar (400 error on create/update without one). `language_preferences.py` — per-language affinity weights for settings/tags/ratings, used for initial base counts and daily growth. `slugify.py` — `validate_slug()` (normalize, validate 3-50 chars), `generate_slug(name, short_id)` (transliterate + UUID suffix). Shared by both Character and Persona. `serializers.py` for ORM→dict with `getattr` fallbacks for new columns, inflated counters (`real + base[lang]`), `vote_score`, `fork_count`, `forked_from_id`, `highlights`. Admin sees `real_chat_count`/`real_like_count`. Admin bypass for edit/delete via `is_admin` param. `router.py` includes `POST /{id}/vote` (upvote/downvote/remove), `POST /{id}/fork` (clone public char as private draft), `GET /{id}/relations` (character connections). `CharacterUpdate` schema accepts `original_language` — saved on edit so translations use correct source language. `PUT` endpoint fires `translate_character_all_languages()` background task when translatable fields change. `translation.py` — `translate_character_all_languages(character_id)` translates card + descriptions to all 6 other languages via LLM.
- **`characters/export_import.py`** — SillyTavern character card v1/v2 support. `character_to_card(char)` exports to card v2 JSON (includes speech_pattern in `extensions.sweetsin`). `card_to_character_data(card)` imports from v1/v2, mapping SillyTavern fields to SweetSin fields. SweetSin-specific data in `extensions.sweetsin`.
- **`reports/router.py`** — Report system: `POST /api/characters/{id}/report` (rate limit 5/hr), `GET /api/admin/reports?status=` (admin), `PUT /api/admin/reports/{id}` (admin). Reasons: inappropriate, spam, impersonation, underage, other. Statuses: pending, reviewed, dismissed.

## SEO

- **`seo/router.py`** — SEO prerender endpoints for bots: `/api/seo/home`, `/api/seo/c/{slug}`, `/api/seo/tags/{slug}`, `/api/seo/faq`, `/api/seo/about`, `/api/seo/terms`, `/api/seo/privacy`, `/api/seo/campaigns`, `/api/seo/sitemap.xml`, `/api/seo/robots.txt`, `/api/seo/feed.xml` (RSS). Anti-template variability (slug-hash section rotation, 6 heading/CTA variants). Quality gates for sitemap. noindex for thin pages. **Multi-site support**: `_brand()` helper replaces "SweetSin" with `SITE_NAME` at render time; fiction-mode conditional content for home (title/og/h1), RSS (title/description), Organization JSON-LD, robots.txt (NSFW disallow only for non-fiction). Campaigns endpoint queries DnD-tagged characters, added to sitemap in fiction mode only.
- **`seo/jsonld.py`** — JSON-LD generators: `character_jsonld()` (real counts only, inLanguage, isPartOf, author, UTC dates), `website_jsonld()`, `faq_jsonld()`, `breadcrumb_jsonld()`, `collection_jsonld()`. Dynamic `SITE_URL` from `settings.frontend_url`, `SITE_NAME` from `settings.site_name`. Fiction-mode descriptions for `website_jsonld()` and `software_application_jsonld()`.
- **`stats/router.py`** — `GET /api/stats` — public endpoint, returns inflated users (+1200), messages (+45000), characters, online_now (15-45 pseudo-random, stable per 5-min window via MD5 hash). Excludes admins, @sweetsin, and anonymous system user from all counts.

## Utilities

- **`utils/email.py`** — Async email sender with 3-tier fallback: Resend API (httpx) → SMTP (aiosmtplib, Gmail etc.) → console (dev). `_get_provider()` selects based on env vars. `send_balance_alert(provider, error_details)` — immediate email to all `ADMIN_EMAILS` when a provider returns 402 (no balance), with blacklist duration and re-enable instructions.
- **`utils/error_notifier.py`** — Automatic error monitoring. `AdminEmailHandler(logging.Handler)` on root logger captures ERROR/CRITICAL, buffers in `deque(maxlen=50)`, sends batched email digest every 5 min (CRITICAL = immediate). Dedup, self-filtering (ignores own logger + email logger), thread-safe. Toggle: `setting.notify_errors`. Installed in `main.py` lifespan.

## Autonomous Tasks (`autonomous/`)

Autonomous server tasks (no cron/Celery):

- `scheduler.py` — Hourly check loop via `asyncio.create_task()` in lifespan. State stored in `prompt_templates` with `scheduler.*` keys. 5-min startup delay, 24h task intervals.
- `providers.py` — Shared provider order for all autonomous tasks. Reads `AUTONOMOUS_PROVIDER_ORDER` env var (default: `openai,gemini,deepseek,together,groq,cerebras,openrouter`). Paid models first, free as fallback.
- `text_humanizer.py` — Anti-AI post-processing. Replaces ~65 AI cliche words (RU+EN) with natural alternatives (e.g. "delve"→"explore", "tapestry"→"blend"). `humanize_text(str)` and `humanize_character_data(dict)`.
- `character_generator.py` — Daily character generation: weighted categories (~90% NSFW, 50% erotic fantasy based on sexual fantasy research — Lehmiller/Kinsey — with 70% male fantasies generating female chars, 30% female fantasies generating male chars, 6 erotic CATEGORIES + 16 `_EXAMPLE_THEMES`), LLM invents unique concept + avatar prompt (hardcoded paid NSFW-friendly providers: Together → OpenAI → Claude → DeepSeek, temp=0.95), DALL-E 3 avatar ($0.04/day), anti-AI humanizer on output, auto-translation to EN/ES/FR/DE/PT/IT, saves under @sweetsin user. **Prompt requires**: personality as 8-12 behavioral PList traits with contradictions/flaws/goals/fears/never; greeting structured (action + sensory + dialogue + momentum ending); 2-3 example dialogues in different emotional states; speech_pattern MANDATORY with concrete phrase examples; appearance with character-revealing details and multi-sensory descriptions. NSFW rule: no sexual behavior in personality field.
- `counter_growth.py` — Daily bump of `base_chat_count`/`base_like_count` JSONB on all public characters, scaled by language preferences.
- `highlight_generator.py` — Daily: generates 2 editorial highlight phrases per language (ru/en/es/fr/de/pt/it) for up to 10 characters without highlights. Provider order from `providers.py`. NOT fake reviews — editorial descriptive phrases.
- `relationship_builder.py` — Weekly: finds character pairs with 2+ shared tags, LLM determines relation type (rival/ex/friend/sibling/enemy/lover/ally), creates bidirectional relations with 7-lingual labels (ru/en/es/fr/de/pt/it). Max 3 relations per character, 20 pairs per run. Provider order from `providers.py`.
- `cleanup.py` — Daily cleanup: page_views >90 days, orphan avatar files (not referenced by any character/user).
- `model_monitor.py` — Daily model monitoring. Model listing: Groq/Cerebras/Together/OpenAI/DeepSeek via `client.models.list()`, OpenRouter via httpx (`:free` models only). Health check: tests all paid providers (OpenAI, Claude, Gemini, DeepSeek, Together) with minimal request — reports API key errors, balance issues, model 404s. Stores state in `prompt_templates` (`models.*` keys as JSON). First run saves baseline silently. On changes (added/removed/changed) or health issues — emails all ADMIN_EMAILS with `SITE_NAME` in subject. Registered as task #6 in `scheduler.py`.
