name: ai-chat

services:
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: aichat
      POSTGRES_USER: aichat
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aichat"]
      interval: 5s
      timeout: 3s
      retries: 5

  backend:
    build:
      context: ./backend
      args:
        GIT_COMMIT: ${GIT_COMMIT:-unknown}
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://aichat:${POSTGRES_PASSWORD}@postgres:5432/aichat
      JWT_SECRET: ${JWT_SECRET}
      OPENROUTER_API_KEY: ${OPENROUTER_API_KEY:-}
      GROQ_API_KEY: ${GROQ_API_KEY:-}
      CEREBRAS_API_KEY: ${CEREBRAS_API_KEY:-}
      TOGETHER_API_KEY: ${TOGETHER_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
      QWEN_API_KEY: ${QWEN_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      XAI_API_KEY: ${XAI_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      DEFAULT_MODEL: ${DEFAULT_MODEL:-auto}
      AUTO_PROVIDER_ORDER: ${AUTO_PROVIDER_ORDER:-groq,cerebras,openrouter}
      AUTO_PROVIDER_ORDER_PAID: ${AUTO_PROVIDER_ORDER_PAID:-groq,together,openrouter}
      AUTONOMOUS_PROVIDER_ORDER: ${AUTONOMOUS_PROVIDER_ORDER:-claude,openai,gemini,deepseek,together,groq,cerebras,openrouter}
      PROXY_URL: ${PROXY_URL:-}
      ADMIN_EMAILS: ${ADMIN_EMAILS:-}
      FRONTEND_URL: ${FRONTEND_URL:-}
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-SweetSin <noreply@sweetsin.cc>}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_EMAIL: ${SMTP_FROM_EMAIL:-}
      MAX_AVATAR_SIZE: ${MAX_AVATAR_SIZE:-4194304}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://sweetsin.cc}
      WEB_WORKERS: ${WEB_WORKERS:-2}
      AUTO_CHARACTER_ENABLED: ${AUTO_CHARACTER_ENABLED:-true}
      ENVIRONMENT: production
    volumes:
      - uploads:/app/data/uploads
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  nginx:
    build:
      context: .
      dockerfile: deploy/nginx/Dockerfile
      args:
        NGINX_CONF: ${NGINX_CONF:-nginx-ssl.conf}
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ${HOST_REPO_DIR:-.}/deploy/nginx/certs:/etc/nginx/certs:ro
      - uploads:/app/uploads:ro
    healthcheck:
      test: ["CMD-SHELL", "curl -fsk https://localhost/api/health || curl -fsk http://localhost/api/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  autoheal:
    image: willfarrell/autoheal
    restart: unless-stopped
    environment:
      AUTOHEAL_CONTAINER_LABEL: all
      AUTOHEAL_INTERVAL: 30
      AUTOHEAL_START_PERIOD: 60
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  webhook:
    build: ./deploy/webhook
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      WEBHOOK_SECRET: ${WEBHOOK_SECRET:-}
      HOST_REPO_DIR: ${HOST_REPO_DIR:-/opt/ai-chat}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${HOST_REPO_DIR:-/opt/ai-chat}:${HOST_REPO_DIR:-/opt/ai-chat}

volumes:
  pgdata:
  uploads:
