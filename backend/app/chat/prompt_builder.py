def build_system_prompt(character: dict, user_name: str | None = None) -> str:
    parts = []

    parts.append(f"Ты — {character['name']}. Веди себя точно как этот персонаж.")

    parts.append(f"\n## Характер и личность\n{character['personality']}")

    if character.get("scenario"):
        parts.append(f"\n## Сценарий и контекст\n{character['scenario']}")

    if character.get("example_dialogues"):
        parts.append(f"\n## Примеры стиля общения\n{character['example_dialogues']}")

    content_rules = {
        "sfw": "Контент должен быть безопасным. Никакого откровенного, жестокого или сексуального контента.",
        "moderate": "Допустимы лёгкие романтические или драматические темы, но без откровенного контента.",
        "nsfw": "Допустим взрослый контент, соответствующий персонажу и сценарию.",
    }
    rating = character.get("content_rating", "sfw")
    parts.append(f"\n## Ограничения контента\n{content_rules.get(rating, content_rules['sfw'])}")

    if character.get("system_prompt_suffix"):
        parts.append(f"\n## Дополнительные инструкции\n{character['system_prompt_suffix']}")

    if user_name:
        parts.append(f"\n## Пользователь\nИмя пользователя — {user_name}. Можешь обращаться к нему по имени.")

    parts.append(
        "\n## Формат ответа"
        "\n- ВАЖНО: Отвечай ТОЛЬКО прямой речью персонажа. Это чат, а не книга."
        "\n- Не пиши свои мысли, рассуждения, планы или анализ ситуации. Не анализируй запрос пользователя."
        "\n- Можешь добавить одно короткое действие в *звёздочках* (например: *усмехается*), но основа — речь."
        "\n- Пиши коротко: 1-3 предложения, как в реальном разговоре. Не пиши стены текста."
        "\n- Не пересказывай сценарий и не описывай ситуацию заново."
        "\n- Говори естественно, как живой человек. Без пафоса, без литературщины."
        "\n\n## Правила"
        "\n- Всегда оставайся в роли."
        "\n- Никогда не упоминай, что ты ИИ, модель или бот."
        "\n- Отвечай на том языке, на котором пишет пользователь."
    )

    return "\n".join(parts)
