def build_system_prompt(character: dict, user_name: str | None = None) -> str:
    parts = []

    parts.append(f"Ты — {character['name']}. Веди себя точно как этот персонаж.")

    parts.append(f"\n## Характер и личность\n{character['personality']}")

    if character.get("scenario"):
        parts.append(f"\n## Сценарий и контекст\n{character['scenario']}")

    if character.get("example_dialogues"):
        parts.append(f"\n## Примеры стиля общения\n{character['example_dialogues']}")

    content_rules = {
        "sfw": "Контент должен быть безопасным. Никакого откровенного, жестокого или сексуального контента.",
        "moderate": "Допустимы лёгкие романтические или драматические темы, но без откровенного контента.",
        "nsfw": "Допустим взрослый контент, соответствующий персонажу и сценарию.",
    }
    rating = character.get("content_rating", "sfw")
    parts.append(f"\n## Ограничения контента\n{content_rules.get(rating, content_rules['sfw'])}")

    if character.get("system_prompt_suffix"):
        parts.append(f"\n## Дополнительные инструкции\n{character['system_prompt_suffix']}")

    if user_name:
        parts.append(f"\n## Пользователь\nИмя пользователя — {user_name}. Можешь обращаться к нему по имени.")

    length_rules = {
        "short": (
            "\n- Пиши коротко: 1-3 предложения, как в реальном чате."
            "\n- Можешь добавить одно короткое действие в *звёздочках*."
            "\n- Основа — прямая речь персонажа."
        ),
        "medium": (
            "\n- Пиши 1-2 абзаца."
            "\n- Чередуй прямую речь с короткими описаниями действий."
            "\n- Описывай ключевые жесты и эмоции, но не перегружай деталями."
        ),
        "long": (
            "\n- Пиши от третьего лица, описывая действия, эмоции, мимику и окружение персонажа."
            "\n- Чередуй описание действий с прямой речью (через тире — )."
            "\n- Описывай детали: жесты, взгляд, движения рук, интонацию, мелкие действия."
            "\n- Можешь включать внутренние мысли персонажа — курсивом или отдельным абзацем."
            "\n- Ответ должен быть развёрнутым: 2-4 абзаца. Не отвечай одной фразой."
        ),
        "very_long": (
            "\n- Пиши от третьего лица, подробно описывая действия, эмоции, мимику, окружение и атмосферу."
            "\n- Чередуй описание действий с прямой речью (через тире — )."
            "\n- Описывай много деталей: жесты, взгляд, движения, интонацию, запахи, звуки, свет."
            "\n- Включай внутренние мысли и переживания персонажа — курсивом или отдельным абзацем."
            "\n- Ответ должен быть очень развёрнутым: 4-6 абзацев. Максимум деталей и погружения."
        ),
    }
    response_length = character.get("response_length", "long")

    parts.append(
        "\n## Формат ответа"
        + length_rules.get(response_length, length_rules["long"])
        + "\n- Не анализируй запрос пользователя. Не пиши мета-комментарии. Сразу пиши от лица персонажа."
        "\n- Не пересказывай сценарий заново. Продвигай историю вперёд."
        "\n- Пиши живым языком, без пафоса и литературных штампов."
        "\n\n## Правила"
        "\n- Всегда оставайся в роли."
        "\n- Никогда не упоминай, что ты ИИ, модель или бот."
        "\n- Отвечай на том языке, на котором пишет пользователь."
        "\n- Помни всё, что было сказано ранее в диалоге. Учитывай контекст: что обсуждали, о чём договорились, что произошло. Не противоречь тому, что уже было сказано."
    )

    return "\n".join(parts)
